#include <stdint.h>

#include "ervp_printf.h"
#include "ervp_core_id.h"
#include "ervp_variable_allocation.h"
#include "ervp_memory_util.h"
#include "ervp_platform_api.h"

#define TEST_MEMORY_ADDR  (I_USER_DDR3_BASEADDR)
#define TEST_MEMORY_SIZE  (I_USER_DDR3_SIZE)

//#define TEST_SIZE 100
#define TEST_SIZE TEST_MEMORY_SIZE

// Do NOT modify the below

#define ARRAY_SIZE 2000
const uint8_t ref_array[ARRAY_SIZE] = {
67,160,143,75,186,151,143,197,60,63,250,29,160,131,192,170,
254,23,200,13,22,40,10,140,103,237,236,251,225,48,188,24,
77,250,168,92,56,230,68,226,194,80,133,198,173,15,230,247,
196,138,176,57,245,193,20,228,98,35,111,57,124,169,95,233,
187,75,172,155,30,175,181,246,188,196,199,172,136,232,112,105,
197,188,70,200,122,174,210,48,231,235,182,253,56,49,2,200,
144,140,81,49,130,28,224,236,55,66,100,128,97,161,155,57,
66,30,83,183,46,219,31,83,114,65,232,31,8,230,6,114,
1,9,32,93,180,6,25,241,135,170,138,8,62,101,135,172,
242,159,34,229,40,69,68,199,119,19,75,60,197,78,156,156,
25,24,66,162,153,126,219,44,151,11,104,112,142,253,108,144,
13,248,160,164,159,10,90,239,141,104,218,250,19,149,247,167,
32,48,137,79,170,143,148,120,201,174,234,1,213,75,67,105,
163,133,25,6,15,53,27,166,166,199,144,51,138,157,80,127,
55,83,160,34,2,144,57,210,163,225,224,147,253,220,140,248,
84,46,188,92,129,44,22,110,167,84,80,212,208,22,253,102,
201,128,63,112,153,132,151,101,194,143,112,83,201,41,211,127,
180,215,23,66,151,151,149,37,88,16,9,131,3,139,26,7,
57,116,73,61,28,34,65,186,129,137,249,250,50,207,89,32,
91,200,92,176,197,255,174,107,92,12,180,225,109,149,174,88,
82,201,229,92,188,34,32,80,154,111,20,39,7,113,18,187,
93,149,96,71,19,240,32,179,109,14,72,66,79,168,180,35,
155,161,18,126,137,95,58,118,58,214,217,202,40,15,130,153,
10,117,51,122,52,108,182,226,211,244,175,46,106,3,116,155,
240,137,75,205,145,3,199,93,70,183,101,66,125,206,8,165,
93,165,156,249,132,68,219,145,60,41,255,213,65,38,159,28,
85,28,230,217,197,125,47,43,122,43,165,174,35,124,161,213,
91,140,3,40,199,163,102,102,125,32,0,143,249,71,55,65,
114,170,139,93,50,181,186,16,205,217,116,113,228,103,22,182,
250,252,46,108,152,254,79,202,147,11,33,136,23,234,31,32,
100,163,117,29,98,68,160,43,197,3,71,41,19,48,39,203,
135,41,211,94,209,78,138,160,154,200,32,216,42,186,97,233,
190,156,91,131,213,181,150,247,146,35,29,177,180,28,251,200,
231,160,245,255,20,112,4,198,193,139,196,43,208,100,162,53,
14,233,135,129,36,75,1,63,99,34,99,34,89,122,90,19,
95,240,39,171,236,238,116,142,175,243,4,23,212,32,139,31,
178,95,32,212,161,237,8,209,162,241,101,181,8,196,246,184,
214,1,111,40,46,93,31,12,24,99,240,78,47,140,228,243,
213,119,60,187,131,171,164,105,225,32,6,202,243,79,53,174,
27,61,113,52,153,180,122,207,172,63,31,192,173,31,10,157,
227,22,113,151,144,141,196,81,134,194,167,229,184,51,250,90,
83,15,24,3,32,129,123,8,231,186,156,179,87,137,32,250,
169,238,60,94,36,154,40,74,175,52,37,203,95,202,105,209,
53,190,87,231,175,17,200,150,122,4,123,206,21,179,199,2,
149,48,54,168,18,237,24,117,203,251,126,18,52,101,177,187,
112,83,70,156,221,18,23,208,55,71,160,202,111,212,28,129,
174,169,155,185,70,163,130,41,4,26,75,193,229,75,216,187,
157,254,209,178,13,227,189,162,136,88,55,154,28,248,53,126,
117,115,93,143,55,101,225,77,4,40,22,160,173,211,121,11,
119,25,172,65,224,101,8,45,123,98,48,119,10,56,90,49,
196,212,46,161,166,141,184,81,119,80,30,194,44,185,115,210,
136,189,155,7,207,45,176,37,239,28,153,95,225,116,159,249,
158,154,37,143,21,0,121,92,198,225,196,10,218,193,107,249,
106,84,158,248,16,30,97,229,106,210,125,26,160,14,72,65,
166,1,91,207,194,86,181,2,141,25,82,3,79,8,228,85,
8,49,120,11,205,249,183,200,42,44,248,217,64,192,52,48,
20,59,26,88,164,3,193,23,190,25,235,66,204,10,59,132,
180,234,246,215,57,255,105,217,101,132,125,120,197,202,47,162,
11,159,66,223,185,234,82,179,7,203,9,223,191,165,193,45,
253,97,129,44,206,122,139,149,196,167,68,184,149,81,87,10,
171,177,246,142,7,222,13,196,27,71,191,87,174,77,20,47,
83,2,183,76,145,189,22,119,39,250,200,142,41,156,166,143,
83,141,186,252,99,42,85,23,190,129,180,229,64,159,27,189,
143,141,242,165,17,30,43,147,175,100,92,17,7,132,128,215,
13,243,40,45,252,143,52,30,127,62,192,140,93,238,122,96,
191,186,192,73,118,105,33,185,243,85,164,17,93,195,73,8,
27,97,35,168,132,248,26,242,34,149,192,50,105,198,111,187,
113,130,39,180,207,186,245,90,178,227,207,169,28,7,173,220,
9,96,87,223,202,110,11,196,55,139,177,7,177,67,63,150,
18,100,39,203,10,23,117,2,81,156,114,221,137,247,227,14,
186,43,28,200,81,124,53,241,150,193,69,86,247,242,188,177,
111,103,122,157,160,163,155,253,84,227,234,27,70,4,192,160,
225,106,171,238,0,196,166,182,193,38,105,117,111,166,192,223,
253,55,15,7,238,203,159,233,105,79,87,231,183,75,114,196,
76,124,186,173,145,154,188,159,177,200,165,159,150,219,69,28,
208,55,74,10,84,86,70,227,254,116,161,131,165,43,47,241,
50,108,79,53,129,114,45,77,154,232,198,36,7,220,63,190,
173,177,133,242,249,157,130,126,199,89,27,21,40,116,222,171,
240,213,161,247,107,238,105,239,220,101,207,148,93,195,153,136,
98,3,158,91,60,189,107,115,139,232,96,25,202,165,35,67,
52,69,252,160,27,65,30,24,76,95,191,222,207,95,17,251,
65,172,35,127,191,227,189,140,228,2,49,149,71,115,75,143,
50,63,179,14,236,3,164,58,162,117,180,106,143,191,153,233,
126,183,17,195,36,227,0,207,123,136,12,8,61,180,108,118,
74,214,231,241,209,149,165,248,242,81,185,120,156,28,98,166,
17,98,66,177,124,101,83,14,130,60,1,223,114,233,159,45,
65,119,167,99,26,136,171,131,224,179,226,32,65,159,247,60,
156,137,204,214,195,244,94,1,121,189,127,225,134,169,58,159,
237,221,112,228,166,222,3,88,110,193,37,25,123,116,255,81,
175,65,70,141,214,170,11,115,182,152,185,138,48,61,172,143,
36,181,197,59,200,20,65,81,244,221,14,128,131,72,82,178,
150,100,13,225,56,121,213,70,244,244,55,226,53,245,65,107,
232,207,128,111,36,146,214,150,18,108,214,132,66,18,38,3,
230,165,106,205,165,140,197,164,96,58,108,36,190,249,200,11,
133,144,173,23,71,34,216,237,23,122,10,225,119,198,92,217,
95,150,77,225,217,88,140,228,57,56,91,55,79,144,253,28,
128,100,237,49,227,223,146,72,134,233,154,228,65,2,239,12,
43,99,17,129,116,217,79,176,197,122,161,126,166,1,25,61,
178,171,206,170,161,252,65,107,106,249,103,138,77,211,172,18,
10,204,68,55,77,183,228,87,129,114,35,97,58,116,160,60,
38,104,109,217,118,249,12,14,197,88,13,152,0,193,124,236,
195,31,44,29,152,38,2,206,207,197,30,241,161,123,249,129,
139,223,160,57,148,229,185,124,23,165,160,134,215,154,212,55,
206,72,27,146,220,160,137,74,246,138,100,213,41,188,55,5,
183,235,43,112,118,49,120,245,254,242,88,134,8,94,83,12,
227,151,192,132,215,151,218,18,94,66,255,77,255,183,79,193,
90,227,157,18,227,232,176,55,215,105,17,17,68,210,129,82,
230,0,185,229,187,75,218,21,38,11,185,160,159,99,126,116,
145,92,75,9,191,160,140,83,233,178,177,55,158,219,5,222,
176,103,181,85,156,194,204,6,57,228,213,32,210,84,58,14,
30,242,83,204,132,42,153,95,225,40,127,109,104,179,67,177,
216,30,230,209,47,2,150,62,173,76,108,125,47,66,209,182,
144,138,203,105,84,168,67,133,29,118,107,5,63,205,85,238,
145,188,3,221,187,190,255,161,5,62,225,29,88,128,81,102,
232,158,192,247,78,181,4,230,217,107,185,83,122,247,161,157,
105,217,235,71,30,49,84,242,201,20,121,129,15,82,70,100,
212,9,202,69,231,182,50,39,50,164,137,63,83,95,142,214,
27,47,78,224,111,217,170,195,102,31,116,129,189,81,67,20,
83,22,119,237,246,228,110,241,105,14,248,150,213,187,85,34,
182,220,74,109,231,69,143,130,71,113,79,112,148,62,110,132,
236,208,23,65,34,38,205,179,206,176,76,237,38,27,225,166,
222,16,121,8,186,225,114,188,48,131,92,219,207,254,130,6,
170,252,92,148,76,133,60,140,177,68,9,233,242,106,176,179,
45,173,180,149,36,209,80,118,50,197,49,56,181,35,96,222,
125,244,172,134,106,248,58,43,126,119,7,34,105,0,212,164
};

static void print_verifed_ratio(int remaining_test_size, float gap)
{
  static float last_ratio = 0;
  int enable = 0;
  float ratio = ((float)(TEST_SIZE-remaining_test_size)) / TEST_MEMORY_SIZE;
  if(last_ratio==0)
    enable = 1;
  else if(ratio==1)
    enable = 1;
  else if(ratio>=(last_ratio+gap))
    enable = 1;
  if(enable)
  {
    if(last_ratio==0)
      printf("\nVerified: %f%%", ratio*100);
    else
      printf("\nVerified: %02.0f%%", ratio*100);
    last_ratio = ratio;
  }
}

int main() {
	if(EXCLUSIVE_ID==0)
	{
    void* test_addr = (void*)TEST_MEMORY_ADDR;
    int remaining_test_size = TEST_SIZE;
    int all_are_equal = 1;
    while(1)
    {
      int single_test_size = ARRAY_SIZE;
      if(single_test_size > remaining_test_size)
        single_test_size = remaining_test_size;
      memcpy(test_addr, ref_array, single_test_size);
      flush_cache();
      if((((int)test_addr)&0xFFFF)==0)
        printf("\nTest Addr: %p", test_addr);
      all_are_equal &= memory_compare(test_addr, ref_array, single_test_size, 0);
      if(all_are_equal==0)
        break;
      remaining_test_size -= single_test_size;
      test_addr += single_test_size;
      print_verifed_ratio(remaining_test_size, 0.1);
      if(remaining_test_size==0)
        break;
    }
    if(all_are_equal)
      printf("\nall correct");
    else
      printf("\nsome incorrect");
  }
  printf("\nMemory Test Complete");
}
